{% extends 'layouts/base.html' %}

{% block title %} Market Data Project {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block body_class %} Market Data {% endblock body_class %}

{% block content %}
  
  {% include "includes/navigation-light.html" %}

  <div class="container mt-5">
    <div class="row">
      <div class="col-lg-12 mx-auto">
        <div class="mb-4 w-25">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/presentation.html">Market Data</a></li>
              <li class="breadcrumb-item active" aria-current="page">Python Code</li>
            </ol>
          </nav>
          <h4>Data Stream Processing</h4>
        </div>
        <div class="position-relative border-radius-xl overflow-hidden shadow-lg mb-7">
          <div class="container border-bottom">
            <div class="row justify-space-between py-2">
              <div class="col-lg-3 me-auto">
                <p class="lead text-dark pt-1 mb-0">data-stream-processing.py</p>
              </div>
              <div class="col-lg-3">
                <div class="nav-wrapper position-relative end-0">
                  <ul class="nav nav-pills nav-fill flex-row p-1" role="tablist">
                    <li class="nav-item">
                      <a class="nav-link mb-0 px-0 py-1 active" data-bs-toggle="tab" href="#preview-breadcrumb" role="tab" aria-controls="preview" aria-selected="true">
                        <i class="fas fa-desktop text-sm me-2"></i> Preview
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="#code-breadcrumb" role="tab" aria-controls="code" aria-selected="false">
                        <i class="fas fa-code text-sm me-2"></i> Code
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-content tab-space">
            <div class="tab-pane active" id="preview-breadcrumb">
              <iframe width="100%" height="800px" srcdoc='<!doctype html>
                <html>
    <head>
      
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>

<script>hljs.highlightAll();</script>
    </head>
    <body>
      
      <pre><code class="language-python" >    
        
import json
from websocket import create_connection, WebSocketConnectionClosedException
import psycopg2

# Connect to Coinbase Websocket
ws = create_connection("wss://ws-feed.exchange.coinbase.com")
ws.send(
    json.dumps(
        {
            "type": "subscribe",
            "product_ids": ["BTC-USD", "ETH-USD"],
            "channels": ["matches"],
        }
    )
)

# Connect to QuestDB
conn = psycopg2.connect(
    dbname="qdb",
    user="admin",
    password="quest",
    host="docker_host_ip_address",
    port="8812"
)

# Create the necessary table if it does not exist
with conn:
    cursor = conn.cursor()
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS coinbase_matches (
        symbol STRING, 
        id DOUBLE, 
        price DOUBLE,        
        size DOUBLE, 
        side STRING,
        type STRING,  
        maker_order_id STRING, 
        taker_order_id STRING, 
        sequence DOUBLE,
        timestamp TIMESTAMP 
    ) TIMESTAMP(timestamp) PARTITION BY DAY;
    """)

while True:
    try:
        data = json.loads(ws.recv())
        
        # If the message type is &#39;subscriptions&#39;, skip it
        if data.get(&#39;type&#39;) == &#39;subscriptions&#39;:
            continue
        
        with conn:
            cursor = conn.cursor()
            insert_query = """
                INSERT INTO coinbase_matches (symbol, id, price, size, side, type, maker_order_id, taker_order_id, sequence, timestamp)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s);
                """
            cursor.execute(insert_query, (data[&#39;product_id&#39;], data[&#39;trade_id&#39;], float(data[&#39;price&#39;]), float(data[&#39;size&#39;]), data[&#39;side&#39;], data[&#39;type&#39;], data[&#39;maker_order_id&#39;], data[&#39;taker_order_id&#39;], data[&#39;sequence&#39;], data[&#39;time&#39;]))        conn.commit()

    except WebSocketConnectionClosedException:
        print("Connection closed, retrying...")
        ws = create_connection("wss://ws-feed.exchange.coinbase.com")
    except Exception as e:
        print(e)

 



        
  
        
                '></iframe>


            </div>
            <div class="tab-pane" id="code-breadcrumb">
              <div class="position-relative p-4 pb-2">
                <a class="btn btn-sm bg-gradient-dark position-absolute end-4 mt-3" onclick="copyCode(this);" type="button"><i class="fas fa-copy text-sm me-1"></i> Copy</a>
                <figure class="highlight"><pre><code class="language-html" data-lang="html">
                        
                    import json
                    from websocket import create_connection, WebSocketConnectionClosedException
                    import psycopg2
                    
                    # Connect to Coinbase Websocket
                    ws = create_connection("wss://ws-feed.exchange.coinbase.com")
                    ws.send(
                        json.dumps(
                            {
                                "type": "subscribe",
                                "product_ids": ["BTC-USD", "ETH-USD"],
                                "channels": ["matches"],
                            }
                        )
                    )
                    
                    # Connect to QuestDB
                    conn = psycopg2.connect(
                        dbname="qdb",
                        user="admin",
                        password="quest",
                        host="docker_host_ip_address",
                        port="8812"
                    )
                    
                    # Create the necessary table if it doesn't exist
                    with conn:
                        cursor = conn.cursor()
                        cursor.execute("""
                        CREATE TABLE IF NOT EXISTS coinbase_matches (
                            symbol STRING, 
                            id DOUBLE, 
                            price DOUBLE,        
                            size DOUBLE, 
                            side STRING,
                            type STRING,  
                            maker_order_id STRING, 
                            taker_order_id STRING, 
                            sequence DOUBLE,
                            timestamp TIMESTAMP 
                        ) TIMESTAMP(timestamp) PARTITION BY DAY;
                        """)
                    
                    while True:
                        try:
                            data = json.loads(ws.recv())
                            
                            # If the message type is 'subscriptions', skip it
                            if data.get('type') == 'subscriptions':
                                continue
                            
                            with conn:
                                cursor = conn.cursor()
                                insert_query = """
                                    INSERT INTO coinbase_matches (symbol, id, price, size, side, type, maker_order_id, taker_order_id, sequence, timestamp)
                                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s);
                                    """
                                cursor.execute(insert_query, (data['product_id'], data['trade_id'], float(data['price']), float(data['size']), data['side'], data['type'], data['maker_order_id'], data['taker_order_id'], data['sequence'], data['time']))
                                conn.commit()
                    
                        except WebSocketConnectionClosedException:
                            print("Connection closed, retrying...")
                            ws = create_connection("wss://ws-feed.exchange.coinbase.com")
                        except Exception as e:
                            print(e)
                
            
                
                
                </code></pre>
                </figure>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}

  <script src="/static/assets/js/soft-design-system.min.js?v=1.0.1" type="text/javascript"></script>

{% endblock javascripts %}